/*
‚Äî‚Äî‚Äî‚Äî‚Äî‚ÄîWhat are you doing here ?‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
‚†Ä‚£û‚¢Ω‚¢™‚¢£‚¢£‚¢£‚¢´‚°∫‚°µ‚£ù‚°Æ‚£ó‚¢∑‚¢Ω‚¢Ω‚¢Ω‚£Æ‚°∑‚°Ω‚£ú‚£ú‚¢Æ‚¢∫‚£ú‚¢∑‚¢Ω‚¢ù‚°Ω‚£ù
‚†∏‚°∏‚†ú‚†ï‚†ï‚†Å‚¢Å‚¢á‚¢è‚¢Ω‚¢∫‚£™‚°≥‚°ù‚£é‚£è‚¢Ø‚¢û‚°ø‚£ü‚£∑‚£≥‚¢Ø‚°∑‚£Ω‚¢Ω‚¢Ø‚£≥‚£´‚†á
‚†Ä‚†Ä‚¢Ä‚¢Ä‚¢Ñ‚¢¨‚¢™‚°™‚°é‚£Ü‚°à‚†ö‚†ú‚†ï‚†á‚†ó‚†ù‚¢ï‚¢Ø‚¢´‚£û‚£Ø‚£ø‚£ª‚°Ω‚£è‚¢ó‚£ó‚†è‚†Ä
‚†Ä‚†™‚°™‚°™‚£™‚¢™‚¢∫‚¢∏‚¢¢‚¢ì‚¢Ü‚¢§‚¢Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†à‚¢ä‚¢û‚°æ‚£ø‚°Ø‚£è‚¢Æ‚†∑‚†Å‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†à‚†ä‚†Ü‚°É‚†ï‚¢ï‚¢á‚¢á‚¢á‚¢á‚¢á‚¢è‚¢é‚¢é‚¢Ü‚¢Ñ‚†Ä‚¢ë‚£Ω‚£ø‚¢ù‚†≤‚†â‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚°ø‚†Ç‚††‚†Ä‚°á‚¢á‚†ï‚¢à‚£Ä‚†Ä‚†Å‚†°‚†£‚°£‚°´‚£Ç‚£ø‚†Ø‚¢™‚†∞‚†Ç‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚°¶‚°ô‚°Ç‚¢Ä‚¢§‚¢£‚†£‚°à‚£æ‚°É‚††‚†Ñ‚†Ä‚°Ñ‚¢±‚£å‚£∂‚¢è‚¢ä‚†Ç‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚¢ù‚°≤‚£ú‚°Æ‚°è‚¢é‚¢å‚¢Ç‚†ô‚†¢‚†ê‚¢Ä‚¢ò‚¢µ‚£Ω‚£ø‚°ø‚†Å‚†Å‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†®‚£∫‚°∫‚°ï‚°ï‚°±‚°ë‚°Ü‚°ï‚°Ö‚°ï‚°ú‚°º‚¢Ω‚°ª‚†è‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚£º‚£≥‚£´‚£æ‚£µ‚£ó‚°µ‚°±‚°°‚¢£‚¢ë‚¢ï‚¢ú‚¢ï‚°ù‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚£¥‚£ø‚£æ‚£ø‚£ø‚£ø‚°ø‚°Ω‚°ë‚¢å‚†™‚°¢‚°£‚££‚°ü‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚°ü‚°æ‚£ø‚¢ø‚¢ø‚¢µ‚£Ω‚£æ‚£º‚£ò‚¢∏‚¢∏‚£û‚°ü‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Å‚†á‚†°‚†©‚°´‚¢ø‚£ù‚°ª‚°Æ‚£í‚¢Ω‚†ã‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
*/

package com.example.harpochat.messaging

import android.os.Bundle
import androidx.activity.ComponentActivity
import androidx.activity.compose.setContent
import androidx.activity.enableEdgeToEdge
import androidx.compose.foundation.Canvas
import androidx.compose.foundation.background
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.text.KeyboardOptions
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.automirrored.filled.ArrowBack
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.geometry.Rect
import androidx.compose.ui.graphics.drawscope.Stroke
import androidx.compose.ui.graphics.StrokeCap
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.text.input.KeyboardType
import androidx.compose.ui.unit.dp
import com.example.harpochat.ui.theme.AppColors
import kotlinx.coroutines.delay
import java.security.SecureRandom
import java.util.UUID

class CodepairActivity : ComponentActivity() {
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        enableEdgeToEdge()
        actionBar?.hide()

        setContent {
            CodepairScreen(onBack = { finish() })
        }
    }
}

/* =========================================================
 * √âcran principal (onglets Importer / G√©n√©rer)
 * ========================================================= */
@OptIn(ExperimentalMaterial3Api::class)
@Composable
private fun CodepairScreen(onBack: () -> Unit) {
    val tabs = listOf("Importer", "G√©n√©rer")
    var selected by remember { mutableIntStateOf(0) }

    // ID ‚Äúprofil‚Äù local pour la d√©mo du g√©n√©rateur
    val myUserId = remember { UUID.randomUUID().toString() }

    // üëá R√©cup√®re le contexte une seule fois dans un scope @Composable
    val ctx = LocalContext.current

    MaterialTheme(colorScheme = darkColorScheme()) {
        Scaffold(
            topBar = {
                TopAppBar(
                    title = { Text("Importer √† partir d‚Äôun code") },
                    navigationIcon = {
                        IconButton(onClick = onBack) {
                            Icon(Icons.AutoMirrored.Filled.ArrowBack, contentDescription = "Retour")
                        }
                    }
                )
            },
            containerColor = AppColors.Bg
        ) { padding ->
            Column(
                Modifier
                    .fillMaxSize()
                    .background(AppColors.Bg)
                    .padding(padding)
            ) {
                TabRow(selectedTabIndex = selected, containerColor = AppColors.Sheet) {
                    tabs.forEachIndexed { i, label ->
                        Tab(selected = selected == i, onClick = { selected = i }, text = { Text(label) })
                    }
                }

                when (selected) {
                    0 -> CodepairImporter(
                        modifier = Modifier
                            .weight(1f)
                            .fillMaxWidth(),
                        onSubmit = { id, code ->
                            // üëá Utilise le ctx captur√©, pas LocalContext.current
                            android.widget.Toast
                                .makeText(ctx, "Demande envoy√©e √†\nID: $id\nCode: $code", android.widget.Toast.LENGTH_SHORT)
                                .show()
                        }
                    )

                    1 -> CodepairGenerator(
                        modifier = Modifier
                            .weight(1f)
                            .fillMaxWidth(),
                        myUserId = myUserId,
                        periodSec = 60,
                        passLen = 10
                    )
                }
            }
        }
    }
}

/* =========================================================
 * Onglet IMPORTER (ID + Code) ‚Äî plein √©cran
 * ========================================================= */
@Composable
private fun CodepairImporter(
    modifier: Modifier = Modifier,
    onSubmit: (id: String, code: String) -> Unit
) {
    var requestId by remember { mutableStateOf("") }
    var requestCode by remember { mutableStateOf("") }

    Column(modifier.padding(16.dp)) {
        OutlinedTextField(
            value = requestId,
            onValueChange = { requestId = it },
            label = { Text("ID") },
            singleLine = true,
            modifier = Modifier.fillMaxWidth()
        )
        Spacer(Modifier.height(12.dp))
        OutlinedTextField(
            value = requestCode,
            onValueChange = { requestCode = it },
            label = { Text("Mot de passe (10 caract√®res)") },
            singleLine = true,
            keyboardOptions = KeyboardOptions(keyboardType = KeyboardType.Ascii),
            modifier = Modifier.fillMaxWidth()
        )
        Spacer(Modifier.height(16.dp))
        Button(
            onClick = { onSubmit(requestId.trim(), requestCode.trim()) },
            modifier = Modifier.fillMaxWidth()
        ) { Text("Envoyer la demande") }
    }
}

/* =========================================================
 * Onglet G√âN√âRER (ID fixe + code rotatif + timer synchrone)
 * ========================================================= */
@Composable
private fun CodepairGenerator(
    modifier: Modifier = Modifier,
    myUserId: String,
    periodSec: Int = 60,
    passLen: Int = 10
) {
    // Alphabet sans ambig√ºit√©s
    val alphabet = "ABCDEFGHJKMNPQRSTUVWXYZ23456789abcdefghijkmnpqrstuvwxyz"

    var cycleStartMs by remember { mutableLongStateOf(System.currentTimeMillis()) }
    var secLeft by remember { mutableIntStateOf(periodSec) }
    var passcode by remember { mutableStateOf("") }

    fun genPass(len: Int): String {
        val rnd = SecureRandom()
        val sb = StringBuilder(len)
        repeat(len) { sb.append(alphabet[rnd.nextInt(alphabet.length)]) }
        return sb.toString()
    }

    fun regenNow(now: Long = System.currentTimeMillis()) {
        passcode = genPass(passLen)
        cycleStartMs = now
        secLeft = periodSec
    }

    // Une seule boucle pour piloter timer + r√©g√©n√©ration
    LaunchedEffect(myUserId, passLen, periodSec) {
        regenNow()
        while (true) {
            val now = System.currentTimeMillis()
            val elapsedSec = ((now - cycleStartMs) / 1000).toInt().coerceAtLeast(0)
            val left = (periodSec - (elapsedSec % periodSec))
            if (left != secLeft) secLeft = left

            if (elapsedSec >= periodSec) {
                regenNow(now)
            }
            delay(16L) // ~60 fps pour la fluidit√©
        }
    }

    // Progression fluide horaire (1f -> 0f)
    val progress by produceState(initialValue = 1f, key1 = cycleStartMs, key2 = periodSec) {
        while (true) {
            val now = System.currentTimeMillis()
            val totalMs = periodSec * 1000f
            val remaining = (totalMs - (now - cycleStartMs)).coerceIn(0f, totalMs)
            value = remaining / totalMs
            delay(16L)
        }
    }

    Column(
        modifier
            .fillMaxSize()
            .padding(16.dp),
        horizontalAlignment = Alignment.CenterHorizontally
    ) {
        // Timer au-dessus, centr√©
        MinuteBadgeClockwise(
            progress = progress,
            secLeft = secLeft,
            modifier = Modifier.size(64.dp)
        )
        Spacer(Modifier.height(12.dp))

        // Carte plein √©cran
        Card(
            modifier = Modifier
                .fillMaxWidth()
                .padding(bottom = 16.dp),
            shape = MaterialTheme.shapes.medium
        ) {
            Column(
                Modifier
                    .fillMaxWidth()
                    .padding(16.dp)
            ) {
                Text("ID (fixe)", color = AppColors.Muted, style = MaterialTheme.typography.labelMedium)
                Text(
                    text = myUserId,
                    style = MaterialTheme.typography.bodyLarge,
                    color = AppColors.OnBgPrimary
                )

                Spacer(Modifier.height(12.dp))
                Text("Mot de passe (change toutes les ${periodSec}s)", color = AppColors.Muted, style = MaterialTheme.typography.labelMedium)
                Text(
                    text = passcode.ifEmpty { "‚Äî‚Äî" },
                    style = MaterialTheme.typography.headlineSmall,
                    color = AppColors.OnBgPrimary
                )
            }
        }

        Button(
            onClick = { regenNow() },               // r√©g√©n√©ration imm√©diate + resync
            modifier = Modifier.fillMaxWidth()
        ) { Text("Nouveau code") }
    }
}

/* =========================================================
 * Badge minute (horaire, fluide, centr√©)
 * ========================================================= */
@Composable
private fun MinuteBadgeClockwise(
    progress: Float,      // 1f -> 0f
    secLeft: Int,
    modifier: Modifier = Modifier
) {
    val arcColor = MaterialTheme.colorScheme.primary

    Box(modifier, contentAlignment = Alignment.Center) {
        // Arc sens horaire (en haut -> vers la droite)
        Canvas(Modifier.matchParentSize()) {
            val stroke = Stroke(width = 6.dp.toPx(), cap = StrokeCap.Round)
            val inset = stroke.width / 2
            val rect = Rect(inset, inset, size.width - inset, size.height - inset)
            // piste grise compl√®te
            drawArc(
                color = AppColors.Muted.copy(alpha = 0.25f),
                startAngle = -90f,
                sweepAngle = 360f,
                useCenter = false,
                topLeft = rect.topLeft,
                size = rect.size,
                style = stroke
            )

            // arc en sens horaire
            drawArc(
                color = AppColors.Timer,
                startAngle = -90f,
                sweepAngle = -360f * progress, // ‚Üê n√©gatif = sens horaire
                useCenter = false,
                topLeft = rect.topLeft,
                size = rect.size,
                style = stroke
            )
        }
        Text(
            text = secLeft.toString(),
            style = MaterialTheme.typography.labelLarge,
            color = AppColors.OnBgPrimary
        )
    }
}
